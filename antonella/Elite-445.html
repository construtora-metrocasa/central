<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Página2 - Dashboard</title>
<link rel="icon" href="icon.png" type="image/png">
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
}
iframe {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
#bemVindo {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    background: rgba(255,255,255,0.9);
    padding: 12px 20px;
    border-radius: 8px;
    color: #333;
    font-size: 1.2em;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 1s;
}
</style>
</head>
<body>

<h2 id="bemVindo"></h2>

<iframe id="pbiFrame" src="https://app.powerbi.com/view?r=eyJrIjoiNjk0NGQ1M2ItNWZlNS00YzI2LTkwOGQtZWZlZmUyNmU1MGIzIiwidCI6ImM3NGViY2JkLWE4MGYtNDYwYy1hMDUzLTEwZDViNmY1ZWQwNSJ9"></iframe>

<script>
// ---------------- Cookie ----------------
function getCookie(nome) {
    const match = document.cookie.match(new RegExp('(^| )' + nome + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : null;
}

// ---------------- Função para pegar IP ----------------
async function getIP() {
    try {
        const r = await fetch("https://api.ipify.org?format=json");
        return (await r.json()).ip;
    } catch(e){
        return "";
    }
}

// ---------------- Registro no Google Sheets ----------------
async function registrarAcesso(usuario) {
    const apiUrl = "https://script.google.com/macros/s/AKfycbw8L0ZxkZxQ6E7BuqNPJDlr_xZTBVP12I8duKiU-Us1bS5slw7UJp_obNTrv2KuAuo/exec";
    const dispositivo = navigator.userAgent;
    const horario = new Date().toISOString();
    const link = window.location.href;
    const ip = await getIP();

    try {
        await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({usuario, link, horario, dispositivo, ip})
        });
    } catch(e){
        console.error("Erro ao registrar acesso:", e);
    }
}

// ---------------- Solicitar nome ----------------
function solicitarNomeERegistrar() {
    const usuario = prompt("Digite seu nome para acessar:") || "Desconhecido";
    const usuarioNormalizado = usuario.trim().toUpperCase();
    document.cookie = `usuario=${encodeURIComponent(usuarioNormalizado)}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
    registrarAcesso(usuarioNormalizado);
    return usuarioNormalizado;
}

// ---------------- Buscar lista de apelidos via Apps Script ----------------
async function pegarUsuariosPermitidos() {
    const url = "https://script.google.com/macros/s/AKfycbyNNceznzsqMdS9Us0HJ2a9y-hCCEPMOOzqTfsnXu4iJ_BRmfz-JhJrfT88d8MAJSM/exec";
    try {
        const resposta = await fetch(url);
        const lista = await resposta.json();

        // Normaliza: remove espaços e transforma em maiúsculas
        return lista.map(u => u.trim().toUpperCase());
    } catch(e){
        console.error("Erro ao buscar usuários permitidos:", e);
        return [];
    }
}

// ---------------- Carregamento da página ----------------
window.onload = async function() {
    let usuario = getCookie("usuario");
    const bemVindo = document.getElementById("bemVindo");
    const iframe = document.getElementById("pbiFrame");

    if(!usuario){
        usuario = solicitarNomeERegistrar();
    }

    // Normaliza usuário
    usuario = usuario.trim().toUpperCase();

    const usuariosPermitidos = await pegarUsuariosPermitidos();

    // Validação
    if(!usuariosPermitidos.includes(usuario)){
        alert("Você não tem permissão para acessar esta página!");
        window.location.href = "https://www.google.com";
        return;
    }

    // Usuário permitido → mostra iframe e mensagem
    iframe.style.display = "block";
    bemVindo.innerText = `Bem-vindo, ${usuario}!`;
    registrarAcesso(usuario);

    // Mensagem temporária
    bemVindo.style.opacity = "1";
    setTimeout(() => { bemVindo.style.opacity = "0"; }, 3000);
};
</script>

</body>
</html>
